---
# Install nginx-ingress controller for Rancher access
- name: Install nginx-ingress controller
  hosts: k8s_rancher
  become: true

  tasks:
    - name: Install nginx-ingress controller
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.14.0/deploy/static/provider/baremetal/deploy.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait for nginx-ingress controller to be ready
      shell: kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=300s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Get nginx-ingress service details
      shell: kubectl get svc -n ingress-nginx
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: ingress_svc
      changed_when: false

    - name: Display nginx-ingress service
      debug:
        var: ingress_svc.stdout_lines

    - name: Patch nginx-ingress to use HostPort (for direct access)
      shell: |
        kubectl patch deployment ingress-nginx-controller -n ingress-nginx --type='json' -p='[
          {
            "op": "add",
            "path": "/spec/template/spec/containers/0/ports/0/hostPort",
            "value": 80
          },
          {
            "op": "add",
            "path": "/spec/template/spec/containers/0/ports/1/hostPort",
            "value": 443
          }
        ]'
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: patch_result
      failed_when: false

    - name: Wait for nginx-ingress to restart with HostPort
      shell: kubectl rollout status deployment/ingress-nginx-controller -n ingress-nginx --timeout=300s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update Rancher ingress to use nginx class
      shell: |
        kubectl patch ingress rancher -n cattle-system --type='json' -p='[
          {
            "op": "replace",
            "path": "/spec/ingressClassName",
            "value": "nginx"
          }
        ]'
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: ingress_patch
      failed_when: false

    - name: Get updated Rancher ingress
      shell: kubectl get ingress rancher -n cattle-system -o wide
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: rancher_ingress
      changed_when: false

    - name: Display Rancher ingress
      debug:
        var: rancher_ingress.stdout_lines

    - name: Check if port 443 is now listening
      shell: ss -tlnp | grep :443 || netstat -tlnp | grep :443
      register: port_443_check
      changed_when: false
      failed_when: false

    - name: Display port 443 status
      debug:
        var: port_443_check.stdout_lines

    - name: Display access information
      debug:
        msg:
          - "==============================================="
          - "nginx-ingress Installation Completed!"
          - "==============================================="
          - ""
          - "Rancher should now be accessible at:"
          - "  https://192.168.100.20"
          - "  OR"
          - "  https://192.168.100.20.sslip.io"
          - ""
          - "Bootstrap Password: admin-rancher-2024"
          - ""
          - "Note: You may see a certificate warning (self-signed cert)"
          - "It's safe to proceed - click 'Advanced' > 'Proceed'"
          - ""
          - "If still not accessible, wait 1-2 minutes for nginx to fully start"
          - "Then try again or check: kubectl get pods -n ingress-nginx"
          - "==============================================="
